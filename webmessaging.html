<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genesys Cloud Web Messaging SDK</title>

    <!-- Genesys Cloud Web Messaging Bootstrap Script -->
    <script type="text/javascript">
        (function (g, e, n, es, ys) {
            g["_genesysJs"] = e;
            g[e] =
                g[e] ||
                function () {
                    (g[e].q = g[e].q || []).push(arguments);
                };
            g[e].t = 1 * new Date();
            g[e].c = es;
            ys = document.createElement("script");
            ys.async = 1;
            ys.src = n;
            ys.charset = "utf-8";
            document.head.appendChild(ys);
        })(
            window,
            "Genesys",
            "https://apps.mypurecloud.com.au/genesys-bootstrap/genesys.min.js",
            {
                deploymentId: "bc38d408-bca9-449e-9273-24e848e2a317",
                environment: "apse2"
            }
        );
    </script>

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f2f4f7;
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-top: 10px;
        }

        .card {
            background: #fff;
            width: 90%;
            max-width: 700px;
            margin: 20px auto;
            padding: 20px 25px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: none;
            background: #0077d8;
            color: white;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        button:hover {
            background: #005bb0;
        }

        #logBox {
            background: black;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: Consolas, monospace;
            height: 220px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>

<body>

<h1>Genesys Cloud Web Messaging SDK – Feature Showcase</h1>

<!-- USER INFO CARD -->
<div class="card">
    <h2>User Information</h2>

    <input id="name" type="text" placeholder="Customer Name" value="John Doe">
    <input id="email" type="text" placeholder="Customer Email" value="john.doe@example.com">
    <input id="phone" type="text" placeholder="Phone Number" value="+61412345678">

    <button onclick="openMessenger()">Open Messenger</button>
    <button onclick="setAttributes()">Set Customer Attributes</button>
</div>

<!-- COMMANDS CARD -->
<div class="card">
    <h2>Messaging Controls</h2>

    <button onclick="clearConversation()">Clear Conversation</button>
    <button onclick="clearMessenger()">Clear Messenger</button>
    <button onclick="sendCustomEvent()">Send Custom Event</button>
    <button onclick="openToaster()">Show Toaster Notification</button>
</div>

<!-- LOGS CARD -->
<div class="card">
    <h2>Event Log</h2>
    <div id="logBox"></div>
</div>

<script>
/* ======================================================
   Logging Helper
   ====================================================== */
function log(message) {
    console.log(message);
    const box = document.getElementById("logBox");
    box.innerHTML += message + "<br>";
    box.scrollTop = box.scrollHeight;
}

/* ======================================================
   Open Messenger
   ====================================================== */
function openMessenger() {
    log("Opening Messenger...");

    Genesys("command", "Messenger.open", {},
        () => log("Messenger opened."),
        (err) => log("Messenger open FAILED: " + JSON.stringify(err))
    );
}

/* ======================================================
   Set Custom Attributes (kept as YOU requested)
   ====================================================== */
function setAttributes() {
    log("Setting customer attributes...");

    const custName = document.getElementById("name").value;
    const custEmail = document.getElementById("email").value;
    const custPhone = document.getElementById("phone").value;

    Genesys("command", "Database.set", {
        messaging: {
            customAttributes: {
                name: custName,
                customerName: custName,
                Email: custEmail,
                Phone: custPhone
            }
        }
    });

    log("Custom attributes updated.");
}

/* ======================================================
   Clear Conversation
   ====================================================== */
function clearConversation() {
    log("Clearing conversation...");

    Genesys("command", "MessagingService.clearConversation", {},
        () => log("Conversation cleared."),
        (err) => log("Conversation clear FAILED: " + JSON.stringify(err))
    );
}

/* ======================================================
   Clear Messenger
   ====================================================== */
function clearMessenger() {
    log("Clearing Messenger...");

    Genesys("command", "Messenger.clear", {},
        () => log("Messenger cleared."),
        (err) => log("Messenger clear FAILED: " + JSON.stringify(err))
    );
}

/* ======================================================
   Send Custom Event
   ====================================================== */
function sendCustomEvent() {
    log("Sending custom event...");

    Genesys("command", "MessagingService.sendEvent", {
        eventName: "demoEvent",
        data: {
            clickedAt: new Date().toISOString(),
            demo: true
        }
    });
}

/* ======================================================
   Toaster Notification
   ====================================================== */
function openToaster() {
    log("Opening toaster...");

    Genesys("subscribe", "Toaster.ready", () => {
        Genesys(
            "command",
            "Toaster.open",
            {
                title: "Demo Notification",
                body: "Would you like to take a survey?",
                buttons: { type: "binary", primary: "Yes", secondary: "No" }
            },
            () => log("Toaster opened."),
            (err) => log("Toaster FAILED: " + JSON.stringify(err))
        );
    });
}

/* ======================================================
   Messenger.ready – just for logging / extra subscriptions
   ====================================================== */
let messengerReadySubscribed = false;

Genesys("subscribe", "Messenger.ready", function () {
    if (messengerReadySubscribed) return;
    messengerReadySubscribed = true;

    log("Messenger READY");

    Genesys("subscribe", "MessagingService.conversationUpdated", function (event) {
        log("[Event] conversationUpdated → " + JSON.stringify(event));
    });

    Genesys("subscribe", "MessagingService.messageReceived", function (event) {
        log("[Event] messageReceived → " + JSON.stringify(event));
    });
});

/* ======================================================
   OPTIONAL: Log restored, but don't use it for logic
   ====================================================== */
Genesys("subscribe", "MessagingService.restored", ({ data }) => {
    log("MessagingService RESTORED (ignored for control flow) → " + JSON.stringify(data));
});

/* ======================================================
   OPTIMIZED STARTUP FLOW:
   - Always force fresh session on load
   - Ignore restored for logic; just nuke any old state
   ====================================================== */

Genesys("subscribe", "MessagingService.ready", () => {
    log("MessagingService is now READY – forcing fresh session");

    // 1) Best-effort clear any previous conversation
    Genesys("command", "MessagingService.clearConversation", {},
        () => log("Any previous conversation cleared (or none existed)."),
        (err) => log("clearConversation error (non-fatal): " + JSON.stringify(err))
    );

    // 2) Clear session, then 3) clear messenger cache, then 4) start new conversation
    Genesys(
        "command",
        "MessagingService.clearSession",
        {},
        () => {
            log("Any previous session cleared (or none existed).");

            Genesys(
                "command",
                "Messenger.clear",
                {},
                () => {
                    log("Messenger cache cleared.");

                    Genesys(
                        "command",
                        "MessagingService.startConversation",
                        {},
                        () => log("NEW CONVERSATION started (fresh session)."),
                        (err) => log("startConversation FAILED: " + JSON.stringify(err))
                    );
                },
                (err) => {
                    log("Messenger.clear FAILED (continuing to start new conversation): " + JSON.stringify(err));
                    Genesys(
                        "command",
                        "MessagingService.startConversation",
                        {},
                        () => log("NEW CONVERSATION started (even though Messenger.clear failed)."),
                        (err2) => log("startConversation FAILED: " + JSON.stringify(err2))
                    );
                }
            );
        },
        (err) => {
            log("clearSession FAILED (continuing with fresh conversation anyway): " + JSON.stringify(err));
            Genesys(
                "command",
                "MessagingService.startConversation",
                {},
                () => log("NEW CONVERSATION started (even though clearSession failed)."),
                (err2) => log("startConversation FAILED: " + JSON.stringify(err2))
            );
        }
    );
});
</script>

</body>
</html>
